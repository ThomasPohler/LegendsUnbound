<!-- Roll20 character sheet created by Thomas Pohler -->
<!-- for the TTRPG Legends Unbound, created by Kurt Knudsen and co-created by Thomas Pohler -->



<!-- DEVELOPER NOTES: -->
<!-- Variables are stored between sessions via the "name" attribute -->
<!-- As of this writing, no direct JavaScript manipulation is allowed outside of .addClass()/.removeClass()/.toggleClass()/.on() -->





<div id="full_sheet">





<!------------>
<!-- HEADER -->
<!------------>

<!-- Controls which page is currently active -->
<input type="hidden" name="attr_sheet_tab" value="main" />
<div id="tab_holder">
    <button type="action" name="act_main"><span>Character</span></button>
    <button type="action" name="act_level"><span>Level-Up</span></button>
    <button type="action" name="act_equipment"><span>Equipment</span></button>
    <button type="action" name="act_roleplay"><span>Roleplay</span></button>
    <button type="action" name="act_cheatsheet"><span>Cheatsheet</span></button>
</div>



<div id="button_box" class="container-style">
    <div class="hr"></div><span>TRAIT ROLLS</span><div class="hr"></div>

    <button type="action" name="act_agility"><input type="number" name="attr_agility" readonly="true"/><span>Agility</span></button>
    <button type="action" name="act_apothecary"><input type="number" name="attr_apothecary" readonly="true"/><span>Apothecary</span></button>
    <button type="action" name="act_bargain"><input type="number" name="attr_bargain" readonly="true"/><span>Bargain</span></button>
    <button type="action" name="act_communication"><input type="number" name="attr_communication" readonly="true"/><span>Communication</span></button>
    <button type="action" name="act_detection"><input type="number" name="attr_detection" readonly="true"/><span>Detection</span></button>
    <button type="action" name="act_engineering"><input type="number" name="attr_engineering" readonly="true"/><span>Engineering</span></button>
    <button type="action" name="act_entertainment"><input type="number" name="attr_entertainment" readonly="true"/><span>Entertainment</span></button>
    <button type="action" name="act_etiquette"><input type="number" name="attr_etiquette" readonly="true"/><span>Etiquette</span></button>
    <button type="action" name="act_handiwork"><input type="number" name="attr_handiwork" readonly="true"/><span>Handiwork</span></button>
    <button type="action" name="act_history"><input type="number" name="attr_history" readonly="true"/><span>History</span></button>
    <button type="action" name="act_intuition"><input type="number" name="attr_intuition" readonly="true"/><span>Intuition</span></button>
    <button type="action" name="act_magic"><input type="number" name="attr_magic" readonly="true"/><span>Magic</span></button>
    <button type="action" name="act_might"><input type="number" name="attr_might" readonly="true"/><span>Might</span></button>
    <button type="action" name="act_navigation"><input type="number" name="attr_navigation" readonly="true"/><span>Navigation</span></button>
    <button type="action" name="act_perseverance"><input type="number" name="attr_perseverance" readonly="true"/><span>Perseverance</span></button>
    <button type="action" name="act_profession"><input type="number" name="attr_profession" readonly="true"/><span>Profession</span></button>
    <button type="action" name="act_religion"><input type="number" name="attr_religion" readonly="true"/><span>Religion</span></button>
    <button type="action" name="act_soothe"><input type="number" name="attr_soothe" readonly="true"/><span>Soothe</span></button>
    <button type="action" name="act_stealth"><input type="number" name="attr_stealth" readonly="true"/><span>Stealth</span></button>
    <button type="action" name="act_threat"><input type="number" name="attr_threat" readonly="true"/><span>Threat</span></button>
    <button type="action" name="act_wilderness"><input type="number" name="attr_wilderness" readonly="true"/><span>Wilderness</span></button>

    <div class="hr"></div><span>DIFFICULTY CHECKS</span><div class="hr"></div>

    <button type="action" name="act_reflex"><input type="number" name="attr_reflex" readonly="true"/><span>Reflex</span></button>
    <button type="action" name="act_strength"><input type="number" name="attr_strength" readonly="true"/><span>Strength</span></button>
    <button type="action" name="act_toughness"><input type="number" name="attr_toughness" readonly="true"/><span>Toughness</span></button>
    <button type="action" name="act_heart"><input type="number" name="attr_heart" readonly="true"/><span>Heart</span></button>
    <button type="action" name="act_mind"><input type="number" name="attr_mind" readonly="true"/><span>Mind</span></button>
    <button type="action" name="act_soul"><input type="number" name="attr_soul" readonly="true"/><span>Soul</span></button>

    <div class="hr"></div><span>DEFENSIVE ACTIONS</span><div class="hr"></div>

    <button type="action" name="act_block"><input type="number" name="attr_block" readonly="true"/><span>Block</span></button>
    <button type="action" name="act_dodge"><input type="number" name="attr_dodge" readonly="true"/><span>Dodge</span></button>
    <button type="action" name="act_parry"><input type="number" name="attr_parry" readonly="true"/><span>Parry</span></button>
</div>



<!---------------->
<!-- PAGE: MAIN -->
<!---------------->
<div id="page_main">



    <div id="character_box" class="container-style">
        <div>
            <span>NAME</span>
            <input type="text" name="attr_character_name"/>
        </div>
        <div class="vr"></div>
        <div>
            <span>SPECIES</span>
            <input type="text" name="attr_character_species" />
        </div>
        <div class="vr"></div>
        <div>
            <span>GENDER</span>
            <input type="text" name="attr_character_gender" />
        </div>
        <div class="vr"></div>
        <div>
            <span>PLAYER</span>
            <input type="text" name="attr_character_player" />
        </div>
        <div>
            <span>BACKGROUND</span>
            <input type="text" name="attr_character_background" />
        </div>
        <div class="vr"></div>
        <div>
            <span>AGE</span>
            <input type="text" name="attr_character_age" />
        </div>
        <div class="vr"></div>
        <div>
            <span>SIZE</span>
            <input type="text" name="attr_character_size" />
        </div>
        <div class="vr"></div>
        <div>
            <span>CLASS(ES)</span>
            <input type="text" name="attr_character_class" />
        </div>
    </div>



    <div id="attribute_box" class="container-style">
        <div>
            <span>Health</span>
            <input type="number" name="attr_health" />
            <input type="number" name="attr_health_max" readonly="true" />
        </div>
        <div>
            <span>Mana</span>
            <input type="number" name="attr_mana" />
            <input type="number" name="attr_mana_max" readonly="true" />
        </div>
        <div>
            <span>Death Stacks</span>
            <input type="number" name="attr_deathstacks" />
            <input type="number" name="attr_deathstacks_max" readonly="true" />
        </div>
        <div>
            <span>Equip. Slots</span>
            <input type="number" name="attr_equipslots" />
            <input type="number" name="attr_equipslots_max" readonly="true" />
        </div>
        <div>
            <span>Rest Points</span>
            <input type="number" name="attr_rest" />
            <input type="number" name="attr_rest_max" readonly="true" />
        </div>
    </div>


    
    <div class="tolerance-box">
        <div>
            <span>Acid</span>
            <input type="number" readonly="true" name="attr_acid"/>
        </div>
        <div>
            <span>Cold</span>
            <input type="number" readonly="true" name="attr_cold"/>
        </div>
        <div>
            <span>Death</span>
            <input type="number" readonly="true" name="attr_death"/>
        </div>
        <div>
            <span>Electric</span>
            <input type="number" readonly="true" name="attr_electric"/>
        </div>
        <div>
            <span>Fire</span>
            <input type="number" readonly="true" name="attr_fire"/>
        </div>
        <div>
            <span>Luminous</span>
            <input type="number" readonly="true" name="attr_luminous"/>
        </div>
        <div>
            <span>Physical</span>
            <input type="number" readonly="true" name="attr_physical"/>
        </div>
        <div>
            <span>Poison</span>
            <input type="number" readonly="true" name="attr_poison"/>
        </div>
        <div>
            <span>Psychic</span>
            <input type="number" readonly="true" name="attr_psychic"/>
        </div>
        <div>
            <span>Sonic</span>
            <input type="number" readonly="true" name="attr_sound"/>
        </div>
    </div>



</div> <!-- end: #page-main -->





<!----------------->
<!-- PAGE: LEVEL -->
<!----------------->
<div id="page_level">

</div> <!-- end: #page-level -->





<!--------------------->
<!-- PAGE: EQUIPMENT -->
<!--------------------->
<div id="page_equipment">

</div> <!-- end: #page-equipment -->





<!-------------------->
<!-- PAGE: ROLEPLAY -->
<!-------------------->
<div id="page_roleplay">

</div> <!-- end: #page-roleplay -->





<!---------------------->
<!-- PAGE: CHEATSHEET -->
<!---------------------->
<div id="page_cheatsheet">

</div> <!-- end: #page-cheatsheet -->




</div>





<!-- Displays roll results in Roll20's chat, ID is "r_template" -->
<!-- Hidden on the character sheet inside Roll20, but displays incorrectly if this file is loaded as pure .html -->
<rolltemplate class="sheet-rolltemplate-r_template">
    <!-- At the time of this writing, Roll20's StartRoll() function is incapable of
    creating GM-only rolls (i.e. rolls that only the GM can see).
    
    The following is a nasty workaround to hide rolls from clients. In essence, if the "hide-rolls"
    button is checked, the roll template will output a roll with its important info set to 'display:none;'. 
    In order for the GM to see the roll, they need to set up a third-party browser extension
    (such as Stylus) with the following snippet of CSS:
    .sheet-template-container { display:block !important; }

    These rolls are therefore entirely secured through obscurity, much to my displeasure. -->

    <div class="sheet-template-container" style="border-style:groove; padding:5px;">
        <span style="width:40%; float:right; text-align: right; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size: 13px;">{{character_name}}</span>
        
        <h4 style="color:#00D300;">{{computed::roll}}</h4>
    </div>
</rolltemplate>





<!------------>
<!-- SCRIPT -->
<!------------>
<script type="text/worker">
    // Switches pages
    const pagelist = ["main","level","equipment","cheatsheet","roleplay"];
    pagelist.forEach(page => {
        on(`clicked:${page}`, function() {
            pagelist.forEach(sheet => $20(`#sheet_${sheet}`).addClass("hidden"));
            $20("#sheet_" + page).removeClass("hidden");
            currentPage = page;
        });
    });





    //Handles button presses
    const traitlist = ["agility", "apothecary", "bargain", "communication", "detection", "engineering", "entertainment", "etiquette", "handiwork", "history", "intuition", "magic", "might", "navigation", "perseverance", "profession", "religion", "soothe", "stealth", "threat", "wilderness"];
    traitlist.forEach(trait => {
        on(`clicked:${trait}`, function() {
            getAttrs(["character_name"], function(data) {
                _makeRoll(data);
            })
        });
    });

    const DClist = ["reflex", "strength", "toughness", "heart", "mind", "soul"];
    DClist.forEach(DC => {
        on(`clicked:${DC}`, function() {
            _makeRoll({"bonus": 0, "advantage": 0, "critMin": 20});
        });
    });

    const defenselist = ["block", "dodge", "parry"]
    defenselist.forEach(defense => {
        on(`clicked:${defense}`, function() {
            _makeRoll({"bonus": 0, "advantage": 0, "critMin": 20});
        });
    });




    //Function to make a dice roll
	const _makeRoll = (data) => {

        let rollText;
        if(data.advantage >= 0){
            //If player has advantage, take highest
            rollText = `[[2 + ${data.advantage}]]d10kh2cs>21cf<0 + ${data.bonus}`;
        } else {
            //If player has disadvantage, take lowest
            rollText = `[[2 + ${data.advantage} * -1]]d10kl2cs>21cf<0 + ${data.bonus}`;
        }

        startRoll(`&{template:r_template} {{roll=[[${rollText}]]}} {{character_name=${data.character_name}}}`, (results) => {
            let original = results.results.roll.result;
            let computed = original - data.bonus;
            
            //Determines if the number is a crit
            //computed cannot be directly compared to an integer using "==", so comparisons are instead made using ">"
            if(computed > data.critMin - 1){ //crit
                computed  = original * 2;
            } else if(computed < 3) { //critfail
                computed = Math.ceil(original / 2);
            } else {
                computed = original;
            }

            finishRoll(
                results.rollId,
                {
                    roll: computed
                }
            );
        });
	}
</script>